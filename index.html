<script>
  /****************************************************
   * Michigan Mortgage + Property Tax Calculator
   * Uses nested JSON: { County: { LocalUnit: { School: { homestead, nonhomestead } } } }
   * Expects mi_millage_2024.json in the SAME folder as index.html
   ****************************************************/

  let millageData = {};

  // ========== LOAD MILLAGE JSON ==========
  async function loadMillageData() {
    try {
      // If you move the JSON into /data, change to 'data/mi_millage_2024.json'
      const res = await fetch('mi_millage_2024.json');
      if (!res.ok) {
        console.error('Failed to load millage JSON:', res.status, res.statusText);
        const err = document.getElementById('taxError');
        if (err) err.textContent = 'Unable to load millage JSON. Check file path.';
        return;
      }

      const data = await res.json();
      millageData = data;
      console.log('Millage JSON loaded. Counties:', Object.keys(millageData));

      populateCountyOptions();
    } catch (err) {
      console.error('Error loading millage JSON:', err);
      const errEl = document.getElementById('taxError');
      if (errEl) errEl.textContent = 'Error loading millage data.';
    }
  }

  // ========== DROPDOWN POPULATION ==========
  function populateCountyOptions() {
    const countySelect = document.getElementById('countySelect');
    if (!countySelect || !millageData) return;

    countySelect.innerHTML = '<option value="">Select county…</option>';

    const counties = Object.keys(millageData).sort((a, b) => a.localeCompare(b));
    counties.forEach(cty => {
      const opt = document.createElement('option');
      opt.value = cty;
      opt.textContent = cty;
      countySelect.appendChild(opt);
    });

    countySelect.disabled = false;
  }

  function populateLocalUnits(countyName) {
    const localUnitSelect = document.getElementById('localUnitSelect');
    const schoolSelect = document.getElementById('schoolSelect');
    if (!localUnitSelect || !schoolSelect) return;

    localUnitSelect.innerHTML = '<option value="">Select local unit…</option>';
    schoolSelect.innerHTML = '<option value="">Select school district…</option>';
    schoolSelect.disabled = true;

    const countyObj = millageData[countyName];
    if (!countyName || !countyObj) {
      localUnitSelect.disabled = true;
      return;
    }

    const units = Object.keys(countyObj).sort((a, b) => a.localeCompare(b));
    units.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      localUnitSelect.appendChild(opt);
    });

    localUnitSelect.disabled = false;
  }

  function populateSchools(countyName, localUnitName) {
    const schoolSelect = document.getElementById('schoolSelect');
    if (!schoolSelect) return;

    schoolSelect.innerHTML = '<option value="">Select school district…</option>';

    const countyObj = millageData[countyName];
    if (!countyName || !localUnitName || !countyObj || !countyObj[localUnitName]) {
      schoolSelect.disabled = true;
      return;
    }

    const schools = Object.keys(countyObj[localUnitName]).sort((a, b) => a.localeCompare(b));
    schools.forEach(sc => {
      const opt = document.createElement('option');
      opt.value = sc;
      opt.textContent = sc;
      schoolSelect.appendChild(opt);
    });

    schoolSelect.disabled = false;
  }

  // ========== MILLAGE LOOKUP ==========
  function getMillage({ county, localUnit, school, isPRE }) {
    if (!millageData || !county || !localUnit || !school) return null;

    const countyObj = millageData[county];
    if (!countyObj) return null;

    const unitObj = countyObj[localUnit];
    if (!unitObj) return null;

    const schoolObj = unitObj[school];
    if (!schoolObj) return null;

    const raw = isPRE ? schoolObj.homestead : schoolObj.nonhomestead;
    const rate = typeof raw === 'number' ? raw : parseFloat(raw);
    if (isNaN(rate)) return null;

    return rate;
  }

  // ========== HELPERS ==========
  function parseNumber(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = parseFloat((el.value || '').replace(/,/g, ''));
    return isNaN(v) ? 0 : v;
  }

  function formatCurrency(num) {
    if (num == null || isNaN(num)) return '—';
    return num.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 2
    });
  }

  // ========== PROPERTY TAX CALC (NO OVERRIDE) ==========
  function calculatePropertyTax() {
    const taxError = document.getElementById('taxError');
    if (taxError) taxError.textContent = '';

    const tv = parseNumber('taxableValue');
    const taxDisplay = document.getElementById('taxResult');
    const millageDisplay = document.getElementById('millageResult');

    const countyEl    = document.getElementById('countySelect');
    const localUnitEl = document.getElementById('localUnitSelect');
    const schoolEl    = document.getElementById('schoolSelect');
    const preEl       = document.getElementById('preCheckbox');

    if (!countyEl || !localUnitEl || !schoolEl) return;

    const county    = countyEl.value;
    const localUnit = localUnitEl.value;
    const school    = schoolEl.value;
    const isPRE     = preEl ? preEl.checked : true;

    if (!county || !localUnit || !school) {
      if (taxError) taxError.textContent = 'Select county, local unit, and school district.';
      if (taxDisplay) taxDisplay.textContent = '—';
      if (millageDisplay) millageDisplay.textContent = '—';
      return;
    }

    const millage = getMillage({ county, localUnit, school, isPRE });
    if (millage == null) {
      if (taxError) taxError.textContent = 'No millage found for this combination (check JSON values).';
      if (taxDisplay) taxDisplay.textContent = '—';
      if (millageDisplay) millageDisplay.textContent = '—';
      return;
    }

    // Always show millage once we have a valid combo
    if (millageDisplay) {
      millageDisplay.textContent = millage.toFixed(4) + ' mills';
    }

    // If no taxable value, just show millage and skip tax
    if (!tv) {
      if (taxDisplay) taxDisplay.textContent = '—';
      return { tax: 0, millage };
    }

    const tax = (tv / 1000) * millage;

    if (taxDisplay) taxDisplay.textContent = formatCurrency(tax);

    return { tax, millage };
  }

  // ========== MORTGAGE CALC ==========
  function calculateMortgage() {
    const price = parseNumber('homePriceInput');
    const down = parseNumber('downPaymentInput');
    const rate = parseNumber('interestRateInput'); // annual %
    const years = parseNumber('loanTermYearsInput');

    const principal = Math.max(price - down, 0);
    const monthlyRate = rate > 0 ? (rate / 100) / 12 : 0;
    const nPayments = years * 12;

    let monthlyPI = 0;
    if (monthlyRate > 0 && nPayments > 0) {
      const factor = Math.pow(1 + monthlyRate, nPayments);
      monthlyPI = principal * (monthlyRate * factor) / (factor - 1);
    } else if (nPayments > 0) {
      monthlyPI = principal / nPayments;
    }

    const monthlyPaymentOutput = document.getElementById('monthlyPaymentOutput');
    if (monthlyPaymentOutput) monthlyPaymentOutput.textContent = formatCurrency(monthlyPI);

    // Get annual tax from millage-based calculation
    const taxResultObj = calculatePropertyTax();
    const annualTax = taxResultObj && taxResultObj.tax ? taxResultObj.tax : 0;

    // Optional insurance only
    const annualInsurance = parseNumber('annualInsuranceInput');
    const monthlyTax = annualTax / 12;
    const monthlyIns = annualInsurance / 12;

    const totalMonthly = monthlyPI + monthlyTax + monthlyIns;
    const totalMonthlyOutput = document.getElementById('totalMonthlyOutput');
    if (totalMonthlyOutput) totalMonthlyOutput.textContent = formatCurrency(totalMonthly);

    buildAmortizationTable(principal, monthlyRate, nPayments, monthlyPI);
  }

  // ========== AMORTIZATION TABLE ==========
  function buildAmortizationTable(principal, monthlyRate, nPayments, monthlyPI) {
    const tbody = document.getElementById('amortizationBody');
    if (!tbody) return;

    tbody.innerHTML = '';
    if (!principal || !nPayments || !monthlyPI) return;

    let balance = principal;
    for (let i = 1; i <= nPayments; i++) {
      const interest = balance * monthlyRate;
      const principalPaid = monthlyPI - interest;
      balance -= principalPaid;
      if (balance < 0) balance = 0;

      const tr = document.createElement('tr');

      const tdN = document.createElement('td');
      const tdPay = document.createElement('td');
      const tdPrin = document.createElement('td');
      const tdInt = document.createElement('td');
      const tdBal = document.createElement('td');

      tdN.textContent = i;
      tdPay.textContent = formatCurrency(monthlyPI);
      tdPrin.textContent = formatCurrency(principalPaid);
      tdInt.textContent = formatCurrency(interest);
      tdBal.textContent = formatCurrency(balance);

      tr.appendChild(tdN);
      tr.appendChild(tdPay);
      tr.appendChild(tdPrin);
      tr.appendChild(tdInt);
      tr.appendChild(tdBal);
      tbody.appendChild(tr);

      if (balance <= 0) break;
    }
  }

  // ========== EVENT WIRING ==========
  document.addEventListener('DOMContentLoaded', () => {
    loadMillageData();

    const calcBtn = document.getElementById('calculateButton');
    if (calcBtn) {
      calcBtn.addEventListener('click', (e) => {
        e.preventDefault();
        calculateMortgage();
      });
    }

    const taxBtn = document.getElementById('calculateTaxButton');
    if (taxBtn) {
      taxBtn.addEventListener('click', (e) => {
        e.preventDefault();
        calculatePropertyTax();
      });
    }

    const countySelect = document.getElementById('countySelect');
    const localUnitSelect = document.getElementById('localUnitSelect');
    const schoolSelect = document.getElementById('schoolSelect');

    if (countySelect) {
      countySelect.addEventListener('change', () => {
        populateLocalUnits(countySelect.value);
        calculatePropertyTax();
      });
    }

    if (localUnitSelect) {
      localUnitSelect.addEventListener('change', () => {
        const countyName = countySelect ? countySelect.value : '';
        populateSchools(countyName, localUnitSelect.value);
        calculatePropertyTax();
      });
    }

    if (schoolSelect) {
      schoolSelect.addEventListener('change', () => calculatePropertyTax());
    }

    ['preCheckbox', 'taxableValue'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', () => calculatePropertyTax());
        el.addEventListener('input', () => calculatePropertyTax());
      }
    });
  });
</script>
