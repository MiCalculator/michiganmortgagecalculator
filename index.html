<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Michigan Mortgage & Property Tax Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif; }
    body { margin:0; background:#f5f5f7; color:#111827; }
    .page { max-width:1100px; margin:0 auto; padding:24px 16px 48px; }
    header { margin-bottom:16px; text-align:center; }
    h1 { margin:4px 0 6px; font-size:2rem; font-weight:700; color:#111827; }
    header p { margin:0; color:#4b5563; font-size:.95rem; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#e0f2fe; color:#0369a1; font-size:.78rem; }

    .mode-toggle { display:flex; justify-content:center; margin-bottom:16px; }
    .mode-toggle-inner { display:inline-flex; border-radius:999px; background:#e5e7eb; border:1px solid #d1d5db; overflow:hidden; }
    .mode-button { padding:6px 14px; font-size:.8rem; cursor:pointer; border:none; background:0 0; color:#4b5563; flex:1 1 0; }
    .mode-button.active { background:linear-gradient(135deg,#2563eb,#4f46e5); color:#fff; }

    .grid { display:grid; grid-template-columns:minmax(0,1.3fr) minmax(0,1fr); gap:20px; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .card { background:#fff; border-radius:18px; padding:18px 16px 16px; box-shadow:0 12px 30px rgba(15,23,42,.08); border:1px solid #e5e7eb; }
    .section-label { font-size:.78rem; color:#9ca3af; text-transform:uppercase; margin-bottom:4px; }
    .field-group { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-bottom:10px; }
    label { display:block; font-size:.78rem; margin-bottom:4px; color:#4b5563; }

    input[type=number], select {
      width:100%; padding:7px 9px; border-radius:10px; border:1px solid #d1d5db;
      background:#fff; color:#111827; font-size:.85rem; outline:none;
    }
    input[type=number]:focus, select:focus { border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,.25); }

    .checkbox-row { display:flex; align-items:center; gap:8px; font-size:.8rem; margin:6px 0 10px; color:#4b5563; }
    button { border:none; border-radius:999px; padding:8px 18px; background:linear-gradient(135deg,#2563eb,#4f46e5); color:#fff; font-size:.9rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }

    .results-row { display:flex; flex-wrap:wrap; gap:12px; margin-top:10px; }
    .result-pill { padding:9px 10px; border-radius:14px; background:#f3f4f6; border:1px solid #e5e7eb; font-size:.8rem; min-width:150px; }
    .result-pill .label { font-size:.72rem; color:#6b7280; }
    .result-pill .value { display:block; margin-top:2px; font-size:.95rem; font-weight:600; }

    .advanced-only { display:none; }
    .mode-advanced .advanced-only { display:block; }

    /* DP toggle */
    .dp-row{display:flex; align-items:center; gap:6px;}
    .dp-toggle{display:inline-flex; border-radius:999px; border:1px solid #d1d5db; background:#e5e7eb; overflow:hidden;}
    .dp-mode-button{border:none; background:0; padding:4px 8px; font-size:.75rem; cursor:pointer; color:#4b5563;}
    .dp-mode-button.active{background:#2563eb; color:#fff;}

    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:.76rem; }
    th,td{ padding:4px 5px; text-align:right; border-bottom:1px solid #e5e7eb; }
    th:first-child,td:first-child{text-align:left;}
    thead{background:#f3f4f6;}

    .disclaimer{ margin-top:22px; font-size:.8rem; color:#6b7280; text-align:center; line-height:1.4; }
  </style>
</head>

<body>
  <div class="page mode-advanced">
    <header>
      <div class="pill">MichiganMortgageCalculator.org</div>
      <h1>Michigan Mortgage Calculator</h1>
      <p>Estimate your mortgage payment and property taxes in one place.</p>
    </header>

    <div class="mode-toggle">
      <div class="mode-toggle-inner">
        <button class="mode-button" data-mode="basic">Basic Settings</button>
        <button class="mode-button active" data-mode="advanced">Advanced Settings</button>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT CARD -->
      <div class="card">
        <div class="section-label">Mortgage</div>
        <h2>Monthly Payment</h2>

        <p><strong>Home & loan details</strong></p>
        <div class="field-group">
          <div>
            <label>Home price</label>
            <input id="homePriceInput" type="number" placeholder="300000">
          </div>

          <div>
            <label>Down payment</label>
            <div class="dp-row">
              <input id="downPaymentInput" type="number" placeholder="60000">
              <div class="dp-toggle">
                <button type="button" class="dp-mode-button active" data-mode="dollar">$</button>
                <button type="button" class="dp-mode-button" data-mode="percent">%</button>
              </div>
              <input type="hidden" id="downPaymentMode" value="dollar">
            </div>
          </div>
        </div>

        <div class="field-group">
          <div>
            <label>Interest rate (annual %)</label>
            <input id="interestRateInput" type="number" value="6.2">
          </div>
          <div>
            <label>Loan term (years)</label>
            <input id="loanTermYearsInput" type="number" placeholder="30">
          </div>
        </div>

        <p><strong>Property tax inputs</strong></p>
        <div class="field-group">
          <div>
            <label>County</label>
            <select id="countySelect"><option value="">Select county…</option></select>
          </div>
          <div>
            <label>City / Township / Village</label>
            <select id="localUnitSelect" disabled><option value="">Select local unit…</option></select>
          </div>
        </div>

        <div class="field-group">
          <div>
            <label>School district</label>
            <select id="schoolSelect" disabled><option value="">Select school district…</option></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="checkbox-row">
              <input type="checkbox" id="preCheckbox" checked>
              <label for="preCheckbox">PRE applies</label>
            </div>
          </div>
        </div>

        <!-- HOME INSURANCE -->
        <div class="advanced-only">
          <p><strong>Home Insurance</strong></p>
          <div class="field-group">
            <div>
              <label>Home insurance</label>
              <input id="annualInsuranceInput" type="number" value="1200">
            </div>
          </div>
        </div>

        <!-- PMI -->
        <div class="advanced-only">
          <p><strong>PMI</strong></p>
          <div class="field-group">
            <div>
              <label>PMI rate (annual % of loan)</label>
              <input id="pmiRateInput" type="number" value="0.5">
            </div>
          </div>
          <p style="font-size:.75rem;color:#6b7280;margin-top:2px;">Applied when down payment is less than 20%.</p>
        </div>

        <div style="margin-top:14px;">
          <button id="calculateButton">Calculate payment</button>
        </div>

        <div class="results-row">
          <div class="result-pill"><span class="label">Principal & interest</span><span id="monthlyPaymentOutput" class="value">—</span></div>
          <div class="result-pill"><span class="label">Estimated property tax (annual)</span><span id="taxResult" class="value">—</span></div>
          <div class="result-pill"><span class="label">Millage used</span><span id="millageResult" class="value">—</span></div>
          <div class="result-pill"><span class="label">PMI (monthly)</span><span id="pmiMonthlyOutput" class="value">—</span></div>
          <div class="result-pill"><span class="label">Total monthly (PITI + PMI)</span><span id="totalMonthlyOutput" class="value">—</span></div>
        </div>

        <div id="taxError" class="error-text"></div>
      </div>

      <!-- RIGHT CARD -->
      <div class="card">
        <div class="section-label">Advanced output</div>
        <h2>Amortization Schedule</h2>
        <p>Updates when you click “Calculate payment”.</p>
        <div style="max-height:380px;overflow:auto;border-radius:10px;border:1px solid #e5e7eb;">
          <table>
            <thead>
              <tr><th>#</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th></tr>
            </thead>
            <tbody id="amortizationBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="disclaimer">
      <strong>Disclaimer:</strong> This calculator is for estimates only.
      Figures may not reflect your actual mortgage payment, tax bill, PMI, or insurance cost.
      Property tax estimates use 2024 Michigan millage rates by county / local unit / school district
      with PRE vs non-PRE. Always confirm numbers with your lender, assessor/treasurer, and insurance provider.
    </div>
  </div>

  <script>
    /****************************************************
     * Michigan Mortgage Calculator (2024 Millage Rates)
     * TV assumed = 50% of home price (implicit)
     ****************************************************/
    let millageData = {};

    document.addEventListener("DOMContentLoaded", () => {
      const modeBtns = document.querySelectorAll(".mode-button");
      const page = document.querySelector(".page");

      modeBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          modeBtns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          if (btn.dataset.mode === "advanced") page.classList.add("mode-advanced");
          else page.classList.remove("mode-advanced");
        });
      });

      // Down payment $/%
      const dpBtns = document.querySelectorAll(".dp-mode-button");
      const dpHidden = document.getElementById("downPaymentMode");
      const dpInput = document.getElementById("downPaymentInput");

      dpBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          dpBtns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          dpHidden.value = btn.dataset.mode;
          dpInput.placeholder = btn.dataset.mode === "percent" ? "20" : "60000";
        });
      });

      loadMillageData();
      wireEvents();
    });

    async function loadMillageData() {
      const res = await fetch("mi_millage_2024.json");
      millageData = await res.json();
      populateCountyOptions();
    }

    function populateCountyOptions() {
      const sel = document.getElementById("countySelect");
      sel.innerHTML = "<option value=''>Select county…</option>";
      Object.keys(millageData).sort().forEach(cty => {
        sel.innerHTML += `<option>${cty}</option>`;
      });
    }

    function populateLocalUnits(county) {
      const luSel = document.getElementById("localUnitSelect");
      const scSel = document.getElementById("schoolSelect");

      luSel.innerHTML = "<option value=''>Select local unit…</option>";
      scSel.innerHTML = "<option value=''>Select school district…</option>";
      scSel.disabled = true;

      if (!county) return luSel.disabled = true;

      Object.keys(millageData[county]).sort().forEach(lu => {
        luSel.innerHTML += `<option>${lu}</option>`;
      });
      luSel.disabled = false;
    }

    function populateSchools(county, lu) {
      const scSel = document.getElementById("schoolSelect");
      scSel.innerHTML = "<option value=''>Select school district…</option>";

      if (!county || !lu) return scSel.disabled = true;

      Object.keys(millageData[county][lu]).sort().forEach(s => {
        scSel.innerHTML += `<option>${s}</option>`;
      });
      scSel.disabled = false;
    }

    function getMillage(county, lu, school, pre) {
      const entry = millageData[county]?.[lu]?.[school];
      return pre ? entry?.homestead : entry?.nonhomestead;
    }

    function parseNum(id) {
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v) ? 0 : v;
    }

    function fmt(n) {
      return isNaN(n) ? "—" : n.toLocaleString("en-US",{style:"currency",currency:"USD"});
    }

    function calcTax() {
      const price = parseNum("homePriceInput");
      const county = document.getElementById("countySelect").value;
      const lu = document.getElementById("localUnitSelect").value;
      const school = document.getElementById("schoolSelect").value;
      const pre = document.getElementById("preCheckbox").checked;

      if (!county || !lu || !school || !price) return { tax:0, mill:0 };

      const mill = getMillage(county, lu, school, pre) || 0;
      document.getElementById("millageResult").innerText = mill ? mill.toFixed(4) + " mills" : "—";

      const TV = price * 0.5;
      const tax = (TV / 1000) * mill;
      document.getElementById("taxResult").innerText = fmt(tax);

      return { tax, mill };
    }

    function calcMortgage() {
      const price = parseNum("homePriceInput");
      const dpMode = document.getElementById("downPaymentMode").value;
      const dpVal = parseNum("downPaymentInput");
      const rate = parseNum("interestRateInput");
      const years = parseNum("loanTermYearsInput");

      const down = dpMode === "percent" ? price * (dpVal/100) : dpVal;
      const principal = Math.max(price - down, 0);
      const n = years * 12;
      const r = (rate/100)/12;

      const PI = r ? principal*(r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1) : principal/n;
      document.getElementById("monthlyPaymentOutput").innerText = fmt(PI);

      const { tax } = calcTax();
      const monthlyTax = tax/12;

      const ins = parseNum("annualInsuranceInput")/12;

      let pmi = 0;
      const ltv = principal / price;
      if (ltv > 0.8) pmi = (parseNum("pmiRateInput")/100)*principal/12;
      document.getElementById("pmiMonthlyOutput").innerText = pmi ? fmt(pmi) : "—";

      const total = PI + monthlyTax + ins + pmi;
      document.getElementById("totalMonthlyOutput").innerText = fmt(total);

      buildAmort(principal, r, n, PI);
    }

    function buildAmort(principal, r, n, PI) {
      const body = document.getElementById("amortizationBody");
      body.innerHTML = "";
      let bal = principal;

      for (let i=1;i<=n;i++){
        const interest = bal*r;
        const princ = PI - interest;
        bal -= princ;
        if (bal < 0) bal = 0;

        body.innerHTML += `
          <tr>
            <td>${i}</td>
            <td>${fmt(PI)}</td>
            <td>${fmt(princ)}</td>
            <td>${fmt(interest)}</td>
            <td>${fmt(bal)}</td>
          </tr>`;
        if (bal <= 0) break;
      }
    }

    function wireEvents() {
      document.getElementById("calculateButton").onclick = calcMortgage;
      document.getElementById("countySelect").onchange = e => populateLocalUnits(e.target.value);
      document.getElementById("localUnitSelect").onchange = e => populateSchools(document.getElementById("countySelect").value, e.target.value);
      document.getElementById("schoolSelect").onchange = calcTax;
      document.getElementById("preCheckbox").onchange = calcTax;
      document.getElementById("homePriceInput").oninput = calcTax;
    }
  </script>
</body>
</html>
