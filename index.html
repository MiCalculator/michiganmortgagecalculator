<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Michigan Mortgage Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6HLMW6NEJ4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-6HLMW6NEJ4');
  </script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #f5f5f7;
      color: #111827;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    header {
      margin-bottom: 16px;
      text-align: center;
    }
    h1 {
      margin: 4px 0 6px;
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
    }
    header p {
      margin: 0;
      color: #4b5563;
      font-size: 0.95rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 0.78rem;
    }
    .mode-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }
    .mode-toggle-inner {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      overflow: hidden;
    }
    .mode-button {
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #4b5563;
      flex: 1 1 0;
    }
    .mode-button.active {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #ffffff;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 16px 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 1.15rem;
      color: #111827;
    }
    .card p {
      margin: 0 0 10px;
      font-size: 0.85rem;
      color: #6b7280;
    }
    .section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .field-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 4px;
      color: #4b5563;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      font-size: 0.85rem;
      outline: none;
    }
    input[type="number"]:focus,
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: #4b5563;
    }
    .result-pill {
      flex: 0 0 auto;
      padding: 9px 10px;
      border-radius: 14px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 0.8rem;
      min-width: 150px;
    }
    .result-pill span.label {
      display: block;
      font-size: 0.72rem;
      color: #6b7280;
    }
    .result-pill span.value {
      display: block;
      margin-top: 2px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
    }
    .dp-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dp-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #e5e7eb;
      overflow: hidden;
      flex-shrink: 0;
    }
    .dp-mode-button {
      border: none;
      background: transparent;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      color: #4b5563;
    }
    .dp-mode-button.active {
      background: #2563eb;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <div class="page mode-advanced">
    <header>
      <div class="pill">MichiganMortgageCalculator.org</div>
      <h1>Michigan Mortgage Calculator</h1>
      <p>Estimate your mortgage payment and property taxes.</p>
    </header>

    <div class="mode-toggle">
      <div class="mode-toggle-inner">
        <button class="mode-button" data-mode="basic">Basic Settings</button>
        <button class="mode-button active" data-mode="advanced">Advanced Settings</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-label">Mortgage</div>
        <h2>Monthly Payment</h2>

        <p><strong>Home &amp; loan details</strong></p>

        <div class="field-group">
          <div>
            <label for="homePriceInput">Home price</label>
            <input id="homePriceInput" type="number" placeholder="300000" />
          </div>

          <div>
            <label>Down payment</label>
            <div class="dp-row">
              <input id="downPaymentInput" type="number" placeholder="60000" />
              <div class="dp-toggle">
                <button class="dp-mode-button active" data-mode="dollar">$</button>
                <button class="dp-mode-button" data-mode="percent">%</button>
              </div>
              <input type="hidden" id="downPaymentMode" value="dollar" />
            </div>
          </div>
        </div>

        <div class="field-group">
          <div>
            <label for="interestRateInput">Interest rate (annual %)</label>
            <input id="interestRateInput" type="number" placeholder="6.2" />
            <div id="pmmsNote" class="small-note"></div>
          </div>
          <div>
            <label for="loanTermYearsInput">Loan term (years)</label>
            <input id="loanTermYearsInput" type="number" placeholder="30" />
          </div>
        </div>

        <div class="basic-only" style="margin-top:10px;">
          <p><strong>Taxes, Insurance, HOA &amp; PMI</strong></p>

          <div class="field-group">
            <div>
              <label for="basicTaxAnnualInput">Annual property tax</label>
              <input id="basicTaxAnnualInput" type="number" placeholder="3600" />
            </div>
            <div>
              <label for="basicInsuranceAnnualInput">Home insurance (annual)</label>
              <input id="basicInsuranceAnnualInput" type="number" value="1200" />
            </div>
          </div>

          <div class="field-group">
            <div>
              <label for="basicHoaMonthlyInput">HOA dues (monthly)</label>
              <input id="basicHoaMonthlyInput" type="number" />
            </div>
            <div>
              <label for="basicPmiAnnualInput">PMI (annual)</label>
              <input id="basicPmiAnnualInput" type="number" />
            </div>
          </div>
        </div>

        <div class="advanced-only" style="margin-top:12px;">
          <p><strong>Property tax inputs</strong></p>

          <div class="field-group">
            <div>
              <label for="countySelect">County</label>
              <select id="countySelect"></select>
            </div>

            <div>
              <label for="localUnitSelect">City / Township / Village</label>
              <select id="localUnitSelect" disabled></select>
            </div>
          </div>

          <div class="field-group">
            <div>
              <label for="schoolSelect">School district</label>
              <select id="schoolSelect" disabled></select>
            </div>

            <div>
              <label>&nbsp;</label>
              <div class="checkbox-row">
                <input id="preCheckbox" type="checkbox" checked />
                <label for="preCheckbox">Primary residence (uncheck if rental or second home)</label>
              </div>
            </div>
          </div>
        </div>

        <div class="advanced-only" style="margin-top:4px;">
          <div class="field-group">
            <div>
              <label for="annualInsuranceInput">Home insurance (annual)</label>
              <input id="annualInsuranceInput" type="number" value="1200" />
            </div>

            <div>
              <label for="pmiRateInput">PMI rate</label>
              <input id="pmiRateInput" type="number" value="0.5" />
            </div>
          </div>

          <p style="font-size:0.75rem;color:#6b7280;margin-top:2px;">
            PMI applies only if down payment &lt; 20%.
          </p>
        </div>

        <div style="margin-top:14px;">
          <button id="calculateButton" type="button">Calculate payment</button>
        </div>

        <div class="results-row" style="margin-top:14px;">
          <div class="result-pill">
            <span class="label">Principal &amp; interest</span>
            <span class="value" id="monthlyPaymentOutput">—</span>
          </div>

          <div class="result-pill">
            <span class="label">Estimated property tax (annual)</span>
            <span class="value" id="taxResult">—</span>
          </div>

          <div class="result-pill">
            <span class="label">Millage used</span>
            <span class="value" id="millageResult">—</span>
          </div>

          <div class="result-pill">
            <span class="label">PMI (monthly)</span>
            <span class="value" id="pmiMonthlyOutput">—</span>
          </div>

          <div class="result-pill">
            <span class="label">Total monthly</span>
            <span class="value" id="totalMonthlyOutput">—</span>
          </div>
        </div>

        <div id="taxError" class="error-text"></div>
      </div>

      <div class="card">
        <div class="section-label">Advanced Output</div>
        <h2>Amortization Schedule</h2>
        <p>Updates automatically.</p>

        <div style="max-height:380px;overflow:auto;border-radius:10px;border:1px solid #e5e7eb;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Payment</th>
                <th>Principal</th>
                <th>Interest</th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody id="amortizationBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="disclaimer">
      <strong>Disclaimer:</strong> Estimates only. Property taxes use 2024 Michigan millage rates by county / local
      unit / school district. Taxable value assumed to be 50% of home price. Always confirm with your lender,
      assessor/treasurer, and insurance provider.
      <br><br>
      Contact us at <a href="mailto:michiganmortgagecalculator@gmail.com">michiganmortgagecalculator@gmail.com</a>.
    </div>
  </div>
<script>
/****************************************************
 * Michigan Mortgage Calculator (2024 millage + PMMS)
 ****************************************************/
let millageData = {};
// PMMS defaults (used only if pmms.json fails)
let pmms30yr = 6.23;
let pmms15yr = 5.51;

document.addEventListener("DOMContentLoaded", () => {
  const page = document.querySelector(".page");

  // Mode toggle
  const modeButtons = document.querySelectorAll(".mode-button");
  modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const mode = btn.dataset.mode;
      if (mode === "advanced") {
        page.classList.add("mode-advanced");
        page.classList.remove("mode-basic");
      } else {
        page.classList.add("mode-basic");
        page.classList.remove("mode-advanced");
      }
      calculateMortgage();
    });
  });

  // Down payment $ / %
  const dpButtons = document.querySelectorAll(".dp-mode-button");
  const dpModeHidden = document.getElementById("downPaymentMode");
  const dpInput = document.getElementById("downPaymentInput");

  dpButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      dpButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const mode = btn.dataset.mode;
      dpModeHidden.value = mode;
      dpInput.placeholder = mode === "percent" ? "20" : "60000";
      calculateMortgage();
    });
  });

  fetchPmmsRates();
  loadMillageData();
  wireEvents();
});

/************** PMMS Integration via pmms.json **************/
async function fetchPmmsRates() {
  const pmmsNote = document.getElementById("pmmsNote");

  try {
    const res = await fetch("pmms.json?cache-bust=" + Date.now());
    if (!res.ok) throw new Error("PMMS JSON missing");

    const data = await res.json();

    if (typeof data.pmms30yr === "number") pmms30yr = data.pmms30yr;
    if (typeof data.pmms15yr === "number") pmms15yr = data.pmms15yr;

    applyPmmsDefaults();

    if (pmmsNote) {
      pmmsNote.textContent = "Using latest Freddie Mac PMMS averages (national).";
    }

    console.log("PMMS rates from pmms.json:", pmms30yr, pmms15yr);
  } catch (err) {
    console.error("Could not load pmms.json. Using fallback defaults.", err);

    applyPmmsDefaults();

    if (pmmsNote) {
      pmmsNote.textContent = "Using fallback defaults based on recent Freddie Mac PMMS (national).";
    }
  }
}

function applyPmmsDefaults() {
  const termEl = document.getElementById("loanTermYearsInput");
  const rateEl = document.getElementById("interestRateInput");
  if (!rateEl) return;

  let term = termEl && termEl.value ? parseInt(termEl.value, 10) : 30;
  if (!termEl.value) termEl.value = term;

  if (term <= 20) {
    rateEl.value = pmms15yr.toFixed(2);
  } else {
    rateEl.value = pmms30yr.toFixed(2);
  }

  calculateMortgage();
}

/************** Millage JSON loading **************/
async function loadMillageData() {
  try {
    const res = await fetch("mi_millage_2024.json");
    if (!res.ok) throw new Error("Millage JSON missing");
    millageData = await res.json();
    populateCountyOptions();
  } catch (err) {
    console.error("Error loading millage JSON:", err);
  }
}

function populateCountyOptions() {
  const countySelect = document.getElementById("countySelect");
  if (!countySelect) return;

  countySelect.innerHTML = "<option value=''>Select county…</option>";
  Object.keys(millageData)
    .sort()
    .forEach(cty => {
      const opt = document.createElement("option");
      opt.value = cty;
      opt.textContent = cty;
      countySelect.appendChild(opt);
    });

  countySelect.disabled = false;
}

function populateLocalUnits(countyName) {
  const localUnitSelect = document.getElementById("localUnitSelect");
  const schoolSelect = document.getElementById("schoolSelect");

  localUnitSelect.innerHTML = "<option value=''>Select local unit…</option>";
  schoolSelect.innerHTML = "<option value=''>Select school district…</option>";
  schoolSelect.disabled = true;

  const countyObj = millageData[countyName];
  if (!countyObj) {
    localUnitSelect.disabled = true;
    return;
  }

  Object.keys(countyObj)
    .sort()
    .forEach(lu => {
      const opt = document.createElement("option");
      opt.value = lu;
      opt.textContent = lu;
      localUnitSelect.appendChild(opt);
    });

  localUnitSelect.disabled = false;
}

function populateSchools(countyName, localUnitName) {
  const schoolSelect = document.getElementById("schoolSelect");

  schoolSelect.innerHTML = "<option value=''>Select school district…</option>";

  const countyObj = millageData[countyName];
  if (!countyObj || !countyObj[localUnitName]) {
    schoolSelect.disabled = true;
    return;
  }

  Object.keys(countyObj[localUnitName])
    .sort()
    .forEach(sc => {
      const opt = document.createElement("option");
      opt.value = sc;
      opt.textContent = sc;
      schoolSelect.appendChild(opt);
    });

  schoolSelect.disabled = false;
}

function getMillage({ county, localUnit, school, isPRE }) {
  if (!millageData[county]) return null;
  const unitObj = millageData[county][localUnit];
  if (!unitObj) return null;
  const schoolObj = unitObj[school];
  if (!schoolObj) return null;

  const raw = isPRE ? schoolObj.homestead : schoolObj.nonhomestead;
  const n = typeof raw === "number" ? raw : parseFloat(raw);
  return isNaN(n) ? null : n;
}

/************** Helpers **************/
function parseNumber(id) {
  const el = document.getElementById(id);
  const v = parseFloat((el?.value || "").replace(/,/g, ""));
  return isNaN(v) ? 0 : v;
}

function formatCurrency(num) {
  return num == null || isNaN(num)
    ? "—"
    : num.toLocaleString("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 2
      });
}

/************** Property tax (Advanced mode) **************/
function calculatePropertyTaxAdvanced() {
  const taxError = document.getElementById("taxError");
  if (taxError) taxError.textContent = "";

  const price = parseNumber("homePriceInput");
  const taxDisplay = document.getElementById("taxResult");
  const millageDisplay = document.getElementById("millageResult");

  const county = document.getElementById("countySelect").value;
  const localUnit = document.getElementById("localUnitSelect").value;
  const school = document.getElementById("schoolSelect").value;
  const isPRE = document.getElementById("preCheckbox").checked;

  if (!county || !localUnit || !school) {
    taxDisplay.textContent = "—";
    millageDisplay.textContent = "—";
    return { tax: 0, millage: 0 };
  }

  const millage = getMillage({ county, localUnit, school, isPRE });
  if (millage == null) {
    taxDisplay.textContent = "—";
    millageDisplay.textContent = "—";
    if (taxError) taxError.textContent = "No millage found for this combination.";
    return { tax: 0, millage: 0 };
  }

  millageDisplay.textContent = millage.toFixed(4) + " mills";

  if (!price) {
    taxDisplay.textContent = "—";
    return { tax: 0, millage };
  }

  const taxableValue = price * 0.5;
  const tax = (taxableValue / 1000) * millage;
  taxDisplay.textContent = formatCurrency(tax);

  return { tax, millage };
}

/************** Mortgage Calculation **************/
function calculateMortgage() {
  const isAdvanced = document.querySelector(".page").classList.contains("mode-advanced");

  const price = parseNumber("homePriceInput");

  const dpMode = document.getElementById("downPaymentMode").value;
  const dpInputVal = parseNumber("downPaymentInput");
  const down = dpMode === "percent" ? price * (dpInputVal / 100) : dpInputVal;

  const rate = parseNumber("interestRateInput");
  const years = parseNumber("loanTermYearsInput");

  const principal = Math.max(price - down, 0);
  const nPayments = years * 12;
  const monthlyRate = rate > 0 ? rate / 100 / 12 : 0;

  let monthlyPI = 0;
  if (monthlyRate > 0 && nPayments > 0) {
    const f = Math.pow(1 + monthlyRate, nPayments);
    monthlyPI = principal * (monthlyRate * f) / (f - 1);
  } else if (nPayments > 0) {
    monthlyPI = principal / nPayments;
  }

  document.getElementById("monthlyPaymentOutput").textContent =
    formatCurrency(monthlyPI);

  let monthlyTax = 0;
  let monthlyIns = 0;
  let monthlyPMI = 0;
  let monthlyHOA = 0;

  if (isAdvanced) {
    const { tax } = calculatePropertyTaxAdvanced();
    monthlyTax = tax / 12;

    monthlyIns = parseNumber("annualInsuranceInput") / 12;

    const pmiRate = parseNumber("pmiRateInput");
    if (pmiRate > 0 && price > 0) {
      const ltv = principal / price;
      if (ltv > 0.8) {
        monthlyPMI = (pmiRate / 100) * principal / 12;
      }
    }
    document.getElementById("pmiMonthlyOutput").textContent =
      monthlyPMI > 0 ? formatCurrency(monthlyPMI) : "—";

  } else {
    const annualTax = parseNumber("basicTaxAnnualInput");
    monthlyTax = annualTax / 12;
    document.getElementById("taxResult").textContent =
      annualTax ? formatCurrency(annualTax) : "—";

    monthlyIns = parseNumber("basicInsuranceAnnualInput") / 12;
    monthlyHOA = parseNumber("basicHoaMonthlyInput");
    monthlyPMI = parseNumber("basicPmiAnnualInput") / 12;

    document.getElementById("pmiMonthlyOutput").textContent =
      monthlyPMI ? formatCurrency(monthlyPMI) : "—";

    document.getElementById("millageResult").textContent = "—";
  }

  const totalMonthly =
    monthlyPI + monthlyTax + monthlyIns + monthlyPMI + monthlyHOA;

  document.getElementById("totalMonthlyOutput").textContent =
    formatCurrency(totalMonthly);

  buildAmortizationTable(principal, monthlyRate, nPayments, monthlyPI);
}

/************** Amortization **************/
function buildAmortizationTable(principal, monthlyRate, nPayments, monthlyPI) {
  const tbody = document.getElementById("amortizationBody");
  tbody.innerHTML = "";

  if (!principal || !nPayments || !monthlyPI) return;

  let balance = principal;
  for (let i = 1; i <= nPayments; i++) {
    const interest = balance * monthlyRate;
    const principalPaid = monthlyPI - interest;
    balance -= principalPaid;
    if (balance < 0) balance = 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i}</td>
      <td>${formatCurrency(monthlyPI)}</td>
      <td>${formatCurrency(principalPaid)}</td>
      <td>${formatCurrency(interest)}</td>
      <td>${formatCurrency(balance)}</td>
    `;
    tbody.appendChild(tr);

    if (balance <= 0) break;
  }
}

/************** Auto-events **************/
function wireEvents() {
  document.getElementById("calculateButton")
    .addEventListener("click", calculateMortgage);

  document.getElementById("countySelect")
    .addEventListener("change", () => {
      populateLocalUnits(countySelect.value);
      calculateMortgage();
    });

  document.getElementById("localUnitSelect")
    .addEventListener("change", () => {
      const c = document.getElementById("countySelect").value;
      populateSchools(c, localUnitSelect.value);
      calculateMortgage();
    });

  document.getElementById("schoolSelect")
    .addEventListener("change", calculateMortgage);

  document.getElementById("preCheckbox")
    .addEventListener("change", calculateMortgage);

  document.getElementById("loanTermYearsInput")
    .addEventListener("input", () => {
      const term = parseInt(loanTermYearsInput.value || "30", 10);
      interestRateInput.value =
        term <= 20 ? pmms15yr.toFixed(2) : pmms30yr.toFixed(2);
      calculateMortgage();
    });

  const autoFields = [
    "homePriceInput", "downPaymentInput", "interestRateInput",
    "basicTaxAnnualInput", "basicInsuranceAnnualInput",
    "basicHoaMonthlyInput", "basicPmiAnnualInput",
    "annualInsuranceInput", "pmiRateInput"
  ];
  autoFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", calculateMortgage);
  });
}
</script>

